{% extends "base.html" %}

{% block title %}Solicitar Tutoría - Sistema de Tutorías EPN{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow" style="border: none; border-radius: 12px; background: var(--card-bg);">
                <div style="background: var(--epn-primary); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0; display: flex; align-items: center; gap: 1rem;">
                    <i class="bi bi-plus-circle" style="font-size: 1.5rem;"></i>
                    <h4 class="mb-0" style="font-weight: 700;">Solicitar Nueva Tutoría</h4>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="formSolicitarTutoria">
                        <!-- Paso 1: Seleccionar Asignatura -->
                        <div class="mb-4">
                            <label for="asignatura_id" class="form-label" style="font-weight: 700; color: var(--text-primary);">
                                <span style="color: var(--epn-primary); font-weight: 800;">1.</span> Selecciona la Asignatura
                            </label>
                            <select class="form-select" id="asignatura_id" name="asignatura_id" required style="border: 2px solid var(--border-color); padding: 0.75rem; font-size: 0.95rem; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">-- Selecciona una asignatura --</option>
                                {% for asignatura in asignaturas %}
                                    <option value="{{ asignatura.id }}">
                                        {{ asignatura.codigo }} - {{ asignatura.nombre }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Paso 2: Seleccionar Tutor -->
                        <div class="mb-4" id="divTutor" style="display: none;">
                            <label for="tutor_id" class="form-label" style="font-weight: 700; color: var(--text-primary);">
                                <span style="color: var(--epn-primary); font-weight: 800;">2.</span> Selecciona el Tutor
                            </label>
                            <select class="form-select" id="tutor_id" name="tutor_id" required style="border: 2px solid var(--border-color); padding: 0.75rem; font-size: 0.95rem; background: var(--card-bg); color: var(--text-primary);">
                                <option value="">-- Primero selecciona una asignatura --</option>
                            </select>
                        </div>

                        <!-- Paso 3: Ver Disponibilidad -->
                        <div class="mb-4" id="divDisponibilidad" style="display: none;">
                            <label class="form-label" style="font-weight: 700; color: var(--text-primary);">
                                <span style="color: var(--epn-primary); font-weight: 800;">3.</span> Disponibilidad del Tutor
                            </label>
                            <div id="disponibilidadContent" style="padding: 1.5rem; border-radius: 10px; border: 2px solid var(--border-color); background: var(--icon-bg); color: var(--text-primary); display: flex; align-items: center; gap: 1rem;">
                                <i class="bi bi-info-circle" style="font-size: 1.3rem; color: var(--epn-primary);"></i>
                                <span>Selecciona un tutor para ver su disponibilidad</span>
                            </div>
                        </div>

                        <!-- Paso 4: Seleccionar Fecha y Hora -->
                        <div class="mb-4" id="divFechaHora" style="display: none;">
                            <label class="form-label" style="font-weight: 700; color: var(--text-primary);">
                                <span style="color: var(--epn-primary); font-weight: 800;">4.</span> Selecciona Fecha y Hora
                            </label>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="fecha" class="form-label" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Fecha</label>
                                    <input type="date" class="form-control" id="fecha" name="fecha" required style="border: 2px solid var(--border-color); padding: 0.75rem; background: var(--card-bg); color: var(--text-primary);">
                                </div>
                                <div class="col-md-4">
                                    <label for="hora_inicio" class="form-label" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Hora Inicio</label>
                                    <input type="time" class="form-control" id="hora_inicio" name="hora_inicio" required style="border: 2px solid var(--border-color); padding: 0.75rem; background: var(--card-bg); color: var(--text-primary);">
                                </div>
                                <div class="col-md-4">
                                    <label for="hora_fin" class="form-label" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Hora Fin</label>
                                    <input type="time" class="form-control" id="hora_fin" name="hora_fin" required style="border: 2px solid var(--border-color); padding: 0.75rem; background: var(--card-bg); color: var(--text-primary);">
                                </div>
                            </div>
                            <small style="color: var(--epn-primary); display: flex; gap: 0.5rem; margin-top: 0.8rem;">
                                <i class="bi bi-info-circle" style="flex-shrink: 0;"></i>
                                <span>Selecciona una fecha y hora dentro de la disponibilidad mostrada</span>
                            </small>
                        </div>

                        <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <a href="{{ url_for('main.estudiante_dashboard') }}" class="btn" style="padding: 0.75rem 1.5rem; background: var(--text-secondary); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s;">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="btnEnviar" disabled style="padding: 0.75rem 1.5rem; font-weight: 600;">
                                <i class="bi bi-check-circle"></i> Confirmar Tutoría
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('asignatura_id').addEventListener('change', function() {
    const asignaturaId = this.value;
    const divTutor = document.getElementById('divTutor');
    const tutorSelect = document.getElementById('tutor_id');
    
    if (asignaturaId) {
        // Cargar tutores disponibles para esta asignatura
        fetch(`/api/tutores-por-asignatura/${asignaturaId}`)
            .then(response => response.json())
            .then(data => {
                tutorSelect.innerHTML = '<option value="">-- Selecciona un tutor --</option>';
                data.forEach(tutor => {
                    const option = document.createElement('option');
                    option.value = tutor.id;
                    option.textContent = tutor.nombre;
                    tutorSelect.appendChild(option);
                });
                divTutor.style.display = 'block';
            });
    } else {
        divTutor.style.display = 'none';
        document.getElementById('divDisponibilidad').style.display = 'none';
        document.getElementById('divFechaHora').style.display = 'none';
    }
});

document.getElementById('tutor_id').addEventListener('change', function() {
    const tutorId = this.value;
    const asignaturaId = document.getElementById('asignatura_id').value;
    const divDisponibilidad = document.getElementById('divDisponibilidad');
    const disponibilidadContent = document.getElementById('disponibilidadContent');
    
    if (tutorId && asignaturaId) {
        // Cargar disponibilidad del tutor
        fetch(`/api/disponibilidad-tutor/${tutorId}/${asignaturaId}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-sm" style="margin: 0; background: var(--card-bg); border-radius: 8px; overflow: hidden;">';
                    html += '<thead><tr style="background: var(--icon-bg);"><th style="color: var(--text-primary); font-weight: 700; padding: 0.8rem; border: none;">Día</th><th style="color: var(--text-primary); font-weight: 700; padding: 0.8rem; border: none;">Horario</th><th style="color: var(--text-primary); font-weight: 700; padding: 0.8rem; border: none;">Modalidad</th><th style="color: var(--text-primary); font-weight: 700; padding: 0.8rem; border: none;">Ubicación</th></tr></thead><tbody>';
                    
                    data.forEach(disp => {
                        html += `<tr style="border-bottom: 1px solid var(--border-color); background: var(--card-bg);">
                            <td style="padding: 0.8rem; color: var(--text-primary); border: none;"><strong>${disp.dia}</strong></td>
                            <td style="padding: 0.8rem; color: var(--text-primary); border: none;">${disp.hora_inicio} - ${disp.hora_fin}</td>
                            <td style="padding: 0.8rem; border: none;"><span style="background: ${disp.modalidad === 'virtual' ? 'rgba(13, 71, 161, 0.1)' : 'rgba(46, 125, 50, 0.1)'}; color: ${disp.modalidad === 'virtual' ? 'var(--epn-primary)' : 'var(--epn-success)'}; padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">${disp.modalidad}</span></td>
                            <td style="padding: 0.8rem; color: var(--text-primary); border: none;"><small>${disp.ubicacion}</small></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    disponibilidadContent.style.background = 'rgba(46, 125, 50, 0.1)';
                    disponibilidadContent.style.color = 'var(--epn-success)';
                    disponibilidadContent.style.border = '2px solid var(--epn-success)';
                    disponibilidadContent.innerHTML = html;
                    
                    divDisponibilidad.style.display = 'block';
                    document.getElementById('divFechaHora').style.display = 'block';
                    document.getElementById('btnEnviar').disabled = false;
                } else {
                    disponibilidadContent.style.background = 'rgba(255, 149, 0, 0.1)';
                    disponibilidadContent.style.color = 'var(--epn-warning)';
                    disponibilidadContent.style.border = '2px solid var(--epn-warning)';
                    disponibilidadContent.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Este tutor no tiene disponibilidad configurada para esta asignatura';
                    divDisponibilidad.style.display = 'block';
                    document.getElementById('divFechaHora').style.display = 'none';
                    document.getElementById('btnEnviar').disabled = true;
                }
            });
    } else {
        divDisponibilidad.style.display = 'none';
        document.getElementById('divFechaHora').style.display = 'none';
        document.getElementById('btnEnviar').disabled = true;
    }
});

// Establecer fecha mínima como hoy
const fechaInput = document.getElementById('fecha');
const hoy = new Date().toISOString().split('T')[0];
fechaInput.min = hoy;
</script>
{% endblock %}
